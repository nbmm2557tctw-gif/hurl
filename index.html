<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="utf-8">
  <title>GPS ç®¡ç†å¾Œå°</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: Arial;
      margin: 10px;
    }

    #map {
      width: 100%;
      height: 60vh;
      border: 1px solid #ccc;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 6px;
      font-size: 14px;
    }

    thead {
      background: #f5f5f5;
    }

    #controls {
      margin-bottom: 10px;
    }
  </style>
</head>

<body>
  <h2>ğŸ“ GPS ç®¡ç†å¾Œå°</h2>

  <div id="controls">
    é¡¯ç¤ºæœ€æ–°å¹¾ç­†ï¼š
    <select id="limit">
      <option>50</option>
      <option selected>100</option>
      <option>200</option>
    </select>
    <button id="refresh">é‡æ–°æ•´ç†</button>
  </div>

  <div id="map"></div>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>æ™‚é–“</th>
        <th>ä½¿ç”¨è€…</th>
        <th>è£ç½®</th>
        <th>ç·¯åº¦</th>
        <th>ç¶“åº¦</th>
      </tr>
    </thead>
    <tbody id="list"></tbody>
  </table>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.13.0/firebase-firestore-compat.js"></script>

  <script>
    // Firebase è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyCx1UM6WQl0QCtOorrq948vOuQXvbJsYyo",
      authDomain: "gpsjs-1a57c.firebaseapp.com",
      projectId: "gpsjs-1a57c",
      storageBucket: "gpsjs-1a57c.firebasestorage.app",
      messagingSenderId: "1037083506711",
      appId: "1:1037083506711:web:eb6af44deac1da54950452",
      measurementId: "G-Q87L4TBT4Z"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Leaflet åœ°åœ–åˆå§‹åŒ–
    const map = L.map('map').setView([23.5, 121], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let markers = [];

    function clearMarkers() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
    }

    async function loadData() {
      const limit = parseInt(document.getElementById('limit').value, 10) || 100;
      const listEl = document.getElementById('list');
      listEl.innerHTML = '';
      clearMarkers();

      const snapshot = await db.collection('gps_logs')
        .orderBy('timestamp', 'desc')
        .limit(limit)
        .get();

      let idx = 0;
      snapshot.forEach(doc => {
        idx++;
        const d = doc.data();
        const ts = d.timestamp ? new Date(d.timestamp.seconds * 1000).toLocaleString() : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${idx}</td><td>${ts}</td><td>${d.userid}</td><td>${d.device}</td><td>${d.latitude}</td><td>${d.longitude}</td>`;
        listEl.appendChild(tr);

        if (d.latitude && d.longitude) {
          const marker = L.marker([d.latitude, d.longitude])
            .addTo(map)
            .bindPopup(`${d.userid} ${ts}`);
          markers.push(marker);
        }
      });

      if (markers.length) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds());
      }
    }

    document.getElementById('refresh').addEventListener('click', loadData);
    document.getElementById('limit').addEventListener('change', loadData);
    window.onload = loadData;
  </script>
</body>

</html>